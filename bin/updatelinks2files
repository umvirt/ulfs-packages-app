#!/usr/bin/env php
<?php
/**
 * ULFS Packages Web-Application
 *
 * Script to update database links to files
 */

//load application
include "../inc/main.php";

//reset mapping table
$sql="truncate packagesfiles_packages";
$db->execute($sql);

$w="";

if(@$argv[1]){
$w=" where r.`release`=\"".$argv[1]."\"";
}

//get files links in database
$sql="select pf.id, pf.`release`, r.`release` release_code, pf.filename from packagesfiles pf 
left join releases r on r.id=pf.`release`
$w";
$db->execute($sql);
//var_dump($db->error,$sql);
$pfs=$db->dataset;

$c=0;
//for each scaned file 
foreach ($pfs as $pf)
{
$c++;

    //init/reset transaction
    $sqlpf=array();

    //Scan database for links to file

    echo "Processing file \"".$pf['filename']."\" in \"".$pf['release_code']."\" [".$c.'/'.count($pfs)."]...\n";

    //Main Package files

    //search all packages with specific file
    $sqlp="select id from packages where sourcefile=\"".trim($pf['filename'])."\" and `release`=".$pf['release'];
    //echo $sqlp;//exit;
    $db->execute($sqlp);
    //var_dump($db->error);
    $x=$db->dataset;
    //echo count($x); exit;

    $sqlpf=array();
    //create mapping
    foreach ($x as $p){
    //echo $p['id']."\n";
    $sqlpf[]="insert into packagesfiles_packages (packagefile,package) values (".$pf['id'].",".$p['id'].")";
    }


    //Addons

    $sqlp="select package id from addons a 
    left join packages p on p.id=a.package and p.release=".$pf['release']." where filename=\"".trim($pf['filename'])."\"";
    //echo $sqlp;//exit;
    $db->execute($sqlp);
    //var_dump($db->error);
    $x=$db->dataset;
    //echo count($x); exit;

    //create mapping
    foreach ($x as $p){
    //echo $p['id']."\n";
    $sqlpf[]="insert into packagesfiles_packages (packagefile,package) values (".$pf['id'].",".$p['id'].")";
    }


    $db->execute($sqlpf);


}
